<!DOCTYPE html>
<html lang="fr">

<head>
<meta charset="UTF-8">
<title>Set without order dependant properties via Promises \ Tests / Equatorium</title>
<meta name="author" content="Gaëtan Langhade, interfacteur">
<link rel="stylesheet" href="-media/regularize.css">
<style>
body > dl	{
	min-width: 36em;
	width: 50%;
}
body > dl > dt,
body > dl > dd	{
	margin-bottom: 1em;
}
dt,
dd	{
	margin-bottom: .2em;
}
dl	{
	background-color: rgba(0, 51, 25, .07);
	clear: both;
	margin-left: 3.6em;
}
dt	{
	float: left;
	padding-right: 2.4em;
}
</style>
</head>

<body>
<pre></pre>
<dl class="fixing"></dl>
<script src="-media/jquery-2.1.1.min.js"></script>
<script>
/*
tester le support des Promise
attention à console.time sur les autres pages
*/
;(function () {
	"use strict";

	var starting,
		$pre = $("pre"),
		iter = 0,
		req = 0;

	var datas = {
			brut: [2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 54, 76, 234,
				340, 532, 540, 780, 1386, 2660, 4212, 4500, 4680, 4800, 5040, 5760, 6080, 8208, 9000],
			net: {}
		},
		purge = [],
		promNode = function (resolve) {
			++ iter;
			purge = [];
			Promise.all(
				datas.proxy.map(function (value, ind) {
					return $.getJSON("http://www.equatorium.net/e1/ou--outils/-nombres.php?callback=?&nombre=" + value)
						.then(function (factors) {
							var len = factors.length;
							req ++;
							datas.net[value] = "<dl><dt>" + value + "</dt>";
							if (len == 0)
								datas.net[value] += "<dd>Ø</dd>";
							else
								for (var i = 0, len = factors.length; i < len; ++i) {
									if (datas.net[factors[i]] != false)
										datas.net[value] += "<dd>" + datas.net[factors[i]] + "</dd>";
									else {
										datas.net[value] = false;
										break
								}	}
							datas.net[value] != false
							&& (datas.net[value] += "</dl>")
							&& purge.push(ind);
			});	})	)
			.then(function () {
				purge.sort(function (a, b) { return a - b; })
				.reverse();
				for (var i = 0, len = purge.length; i < len; ++i)
					datas.proxy.splice(purge[i], 1);
				for (var key in datas.net)
					if (datas.net[key] == false)
						return promNode(resolve);
				resolve();
		});	};

	datas.proxy = datas.brut.map(function (value) {
		datas.net[value] = false;
		return value;
	})
	.sort(function () { return Math.random() - .5; });

	$pre.append("Données initiales : " + datas.brut.join(",") + "<br><br>");
	$pre.append("Données mélangées : " + datas.proxy.join(",") + "<br><br>");

	starting = new Date();

	new Promise(promNode)
	.then(function () {
		var end = new Date();
		$pre.append(iter + " itérations, " + req + " requêtes Ajax, " + (end - starting) + " millisecondes<br><br>Données finales :<br><br>");
		$("dl").html(
			Object.keys(datas.net).map(function (code) {
				return datas.net[code].replace(/(^<dl>)|(<\/dl>)$/g, "");
			})
			.join("")
			.replace(/<\/dl><\/dd><dd><dl>/g, "")
		);
		return;
		$pre.append("datas.net[4680] == " + datas.net[4680] + "<br><br>");
		$pre.append("résultat total == " + JSON.stringify(datas.net).replace(/"/g, "") + "<br><br>");
		$pre.append("résultat total ordonné == <br>" + Object.keys(datas.net).reduce(function (codeAccu, code) {
			return codeAccu += datas.net[code] + "<br>";
		}, ""));
	});

}) ();
</script>
</body>
</html>
