<!DOCTYPE html>
<html lang="fr">

<head>
<meta charset="UTF-8">
<title>Set without order dependant properties via Promises \ Tests / Equatorium</title>
<meta name="author" content="Gaëtan Langhade, interfacteur">
</head>

<body>
<script src="-media/jquery-2.1.1.min.js"></script>
<script>
;(function () {
	"use strict";
	var url = "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
		querir = function (cb) {
			return new Promise (function (rs) {
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() { //cf. aussi onload et xhr.status >= 200 && xhr.status < 300
					if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0))
						cb(rs);
				};
				xhr.open("GET",url,true);
				xhr.send(null);
		}); }


//OK récupération des responseText ou JSON etc.
	Promise.all([
		$.ajax({
			url: url,
			success: function (got, status, xhr) {
				console.log("github 1");
				console.log(got);
				console.log("status : ", status);
				console.log("xhr : ", xhr);
				return "aa";
			}
		}),
		$.ajax({
			url: url,
			dataType: "json",
			success: function (got, a, b) {
				console.log("github 2");
			}
		})
	]).then(function (v) {
		console.log(v); //uniquement les JSON (got) : l'argument est le tableau des got
	});

	return;

//OK retour manuel
	Promise.all([
		querir(function (r) {
			console.log(1);
			r(1);
		}),
		querir(function (r) {
			console.log(2);
			r(2);
		})
	]).then(function (v) {
		console.log(v); //l'argument est le tableau des valeurs
	});

	return;

//OK récupération des trois paramètres des fonctions gestionnaires (en tout cas de success) dans un tableau
	$.when(
		$.ajax({
			url: url,
			success: function (got, status, xhr) {
				console.log("github 1");
				console.log(got);
				console.log("status : ", status);
				console.log("xhr : ", xhr);
				return "aa";
			}
		}),
		$.ajax({
			url: url,
			success: function (got, a, b) {
				console.log("github 2");
			}
		})
	)
	.then(function (a, b, c, d, e, f) { //un argument par tableau des trois paramètres des fonctions gestionnaires
		console.log("when");
		console.log(a[1]);
		console.log(b);
		a.forEach(function (r) {
			console.log(r);
		})
	});

	return;

//ne marche pas
	$.when(
		$(querir(function (r) {
			console.log(1);
			r(1);
		})),
		querir(function (r) {
			console.log(2);
			r(2);
		})
	)
	.then(function (a, b, c, d, e, f) {
		console.log(a);
		console.log(b);
	});




	return;

	var p = new Promise(function(rs, rj){
			var n = Math.round(Math.random());
			console.log(n);
			n == 0 ? rs("OK-") : rj("nok-");
		});

/*
0 (resolve)
OK-OK2-
OK-OK2-OK3-
OK-OK2-OK3-OK4-
Tout est fini !


1 (reject)
nok-nok2-
nok-nok2-OK4-
Tout est fini !
*/
	p.then(function(a) {
		console.log(a  + "OK2-");
		throw new Error("erreur artificielle"); //cf. aussi http://stackoverflow.com/questions/21260602/how-to-reject-a-promise-from-inside-then-function
		return a  + "OK2-";
	}).then(function(a) {
		console.log(a  + "OK3-");
		return a  + "OK3-";
	}).catch(function(e) {
		console.log(e  + "nok2-");
		return e  + "nok2-";
	}).then(function(a) {
		console.log(a  + "OK4-");
		return a  + "OK4-";
	}, function(e) {
		console.log(e  + "nok3-");
		return e  + "nok3-";
	}).catch(function(e) {
		console.log(e, "T’inquiète donc pas");
	}).then(function(a) {
		return console.log("Tout est fini !");
	});


	return;

	var p = new Promise(function(r){
			r();
		}).then(function () {
			console.log(1);
		});

	p.then(function () {
		console.log(2);
	});

	setTimeout(function () {
		p.then(function () {
			console.log(3);
		});
	}, 1000);



return;



// (function(){
// 	var a, b,
// 		p = new Promise(function(r){
// 			Promise.cast($.ajax({
// 				url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
// 			}));
// 			Promise.cast($.ajax({
// 				url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
// 			}));
// 		}).then(function () {
// 			console.log("a");
// 		});
// 	console.log("fin");
// })();
// console.log("end");


return;

(function(){
	var a, b,
		p = new Promise(function(r){
			console.log(p);
			a = typeof b == "undefined" ? Promise.resolve(p).then(function(){ a = b; }) : b;
			b = 104;
			r();
		}).then(function () {
			console.log(a);
		});
	console.log("fin");
})();
console.log("end");



return;


	$.when(
		$.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function (got, status, xhr) {
				console.log("github 1");
				console.log(got);
				console.log("status : ", status);
				console.log("xhr : ", xhr);
				return "aa";
			}
		}),
		$.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function (got, a, b) {
				console.log("github 2");
			}
		})
	)
	.then(function () {
		console.log(3);
	})
	.then(function (a, b, c, d, e, f) {
		console.log(a);
		console.log(b);
		console.log(c);
		console.log(d);
		console.log(e);
		return console.log(f);
		return console.log(a, b, c, d, e, f);
		console.log("then", a1, b1, JSON.stringify(got1).substring(0, 100));
		console.log("then", a2, b2, JSON.stringify(got2).substring(0, 100));
	});

	// .done(function (got1, got2) {
	// 	console.log(JSON.stringify(got1).substring(0, 100));
	// 	console.log(JSON.stringify(got2).substring(0, 100));
	// });
return;


	$.when(1)
	.then(function () {
		$.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function () {
				console.log("github 1");
			}
		});
	})
	.then(function () {
		$.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function () {
				console.log("github 2");
			}
		});
	});

return;


	$.when(1)
	.then(function () {
		return $.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function () {
				console.log("github 1");
			}
		});
	})
	.then(function () {
		return $.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function () {
				console.log("github 2");
			}
		});
	});





return;


	$.when(1)
	.then(function () {
		return $.ajax({
			url: "https://api.github.com/search/repositories?q=form+in:name&type=Repositories&per_page=50&client_id=e8ce07d7ca81454ca7ca&client_secret=58e01a1e64bc997753cf364b80f53d922468722c",
			dataType: "json",
			success: function () {
				console.log("github");
			}
		});
	})
	.then(function () {
		return $.ajax({
			url: "http://localhost:8888/repositories.php",
			dataType: "json",
			success: function () {
				console.log("local");
			}
		});
	});





return;





	$.when(1)
	.then(function () {
		return setTimeout(function () {
			console.log(1);
		}, 1000);
	})
	.then(function () {
		return setTimeout(function () {
			console.log(2);
		}, 500);
	});

}) ();
</script>
</body>
</html>
