<!DOCTYPE html>
<html lang="fr">

<head>
<meta charset="UTF-8">
<title>Set without order dependant properties via Promises \ Tests / Equatorium</title>
<meta name="author" content="Gaëtan Langhade, interfacteur">
</head>

<body>
<pre></pre>
<script src="-media/jquery-2.1.1.min.js"></script>
<script>
;(function () {
	"use strict";

	var $pre = $("pre"),
		iter = 0;

	var datas = {
			brut: [2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 54, 76, 234,
				340, 532, 540, 780, 1386, 2660, 4212, 4500, 4680, 4800, 5040, 5760, 6080, 8208, 9000],
			net: {}
		},
		purge = [],
		promNode = function (resolve) {
			++ iter;
			purge = [];
			Promise.all(
				datas.proxy.map(function (value, ind) {
					return $.getJSON("http://www.equatorium.net/e1/ou--outils/-nombres.php?callback=?&nombre=" + value)
						.then(function (factors) {
							datas.net[value] = value + " : {";
							for (var i = 0, len = factors.length; i < len; ++i) {
								if (datas.net[factors[i]] != false)
									datas.net[value] += datas.net[factors[i]];
								else {
									datas.net[value] = false;
									break
							}	}
							datas.net[value] != false
							&& (datas.net[value] += "} ")
							&& purge.push(ind);
			});	})	)
			.then(resolve);
		},
		promThen = function () {
			purge.sort(function (a, b) { return a - b; })
			.reverse();
			for (var i = 0, len = purge.length; i < len; ++i)
				datas.proxy.splice(purge[i], 1);
			for (var key in datas.net)
				if (datas.net[key] == false)
					return new Promise(promNode).then(promThen);
		};

	datas.proxy = datas.brut.map(function (value) {
		datas.net[value] = false;
		return value;
	})
	.sort(function () { return Math.random() - .5; });

	$pre.append("données initiales : " + datas.brut.join(",") + "<br><br>");
	$pre.append("données mélangées : " + datas.proxy.join(",") + "<br><br>");

	console.time("a");

	new Promise(promNode)
	.then(promThen)
	.then(function () {
		$pre.append(console.timeEnd("a") + " millisecondes<br><br>");
		$pre.append(iter + " itérations<br><br>");
		$pre.append("datas.net[4680] == " + datas.net[4680] + "<br><br>");
		$pre.append("résultat total == " + JSON.stringify(datas.net).replace(/"/g, "") + "<br><br>");
		$pre.append("résultat total ordonné == <br>" + Object.keys(datas.net).reduce(function (codeAccu, code) {
			return codeAccu += datas.net[code] + "<br>";
		}, ""));
	});

}) ();
</script>
</body>
</html>
